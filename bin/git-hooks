#!/bin/bash

exname="$(basename "$0")"


gitdir="$(git rev-parse --git-dir)"
if [ "$?" != "0" ]; then
    echo "You are not in a git repository." >&2
    exit 1
fi

githooks_base=$(git config "git-hooks.install-dir")
if [ "$?" != "0" ]; then
    echo "No git-hooks.install-dir variable. Please set this variable with:" >&2
    echo "   git config [--system] git-hooks.install-dir MY_GIT_HOOK_BASE_DIR" >&2
    exit 1
fi

if ! [ -e "$githooks_base/generic-post-receive" ]; then
    echo "Bad path for git-hooks.install_dir !" >&2
    echo "file '$githooks_base/generic-post-receive' not found" >&2
    exit 1
fi


function git_hooks_init() {

    if [ -L "$gitdir/hooks/post-receive" ]; then
       if [ "$(readlink -e "$gitdir/hooks/post-receive")" == \
            "$githooks_base/generic-post-receive" ]; then
           echo "Correct link already existing."
       else
           echo "Error: another link is already set in $gitdir/hooks/post-receive"
           exit 1
       fi
    elif [ -e "$gitdir/hooks/post-receive" ]; then
       echo "Error: a file already exists by the name: gitdir/hooks/post-receive"
       exit 1
    else
        ln -snv "$githooks_base/generic-post-receive" "$gitdir/hooks/post-receive"
    fi

    mkdir -p "$gitdir/hooks/post-receive.d"
}
export -f git_hooks_init


## Check if ssh authentication is passwd-less between localhost and $1 lxc
function can_ssh_without_passwd() {
  ssh -o StrictHostKeyChecking=no -o PasswordAuthentication=no "$1" \
     echo "test" >/dev/null 2>&1
}

## Ensure that ssh authentication is passwd-less between localhost and $1 lxc
function make_ssh_connection_work() {
    host="$1"
    if ! can_ssh_without_passwd "$host"; then
        ## need to create key and send it to HOST
        if ! [ -e ~/.ssh/id_rsa.pub ]; then
            ## need to create a key
            ssh-keygen -t rsa -q -f ~/.ssh/id_rsa -N ""
        fi

        echo "Logging to $host to copy ssh keys:"
        ssh-copy-id "$host"
        if [ "$?" != 0 ]; then
            echo "Error: cannot ssh-copy-id." >&2
            return 1
	fi

    fi

    if ! can_ssh_without_passwd "$host"; then
        echo "Cannot ssh towards $HOST despite copying id ?!" >&2
        return 1
    fi

}

## Ensure that git hooks was inited
function make_git_hooks_inited() {
    if ! [ -d "$gitdir/hooks/post-receive.d" ]; then
        echo "No '$gitdir/hooks/post-receive.d' existing..."
        echo "Perhaps launching 'git-hooks init' will help..."
        git-hooks init
        test "$?" == "0" || return 1
    fi
}

function init_action() {

    local hook_name md5salt md5 name l c hook_src

    hook_name="$1"
    md5salt="$2"

    md5=$(echo "$md5salt" | md5sum | cut -c 1-8 )
    name="${hook_name}_${host}_${md5}"
    l="$gitdir/hooks/post-receive.d/$name.hook"
    c="$gitdir/hooks/post-receive.d/$name.conf"

    if [ -e "$l" ]; then
        echo "File '$l' already exists. Aborting."
        exit 1
    fi
    if [ -e "$c" ]; then
        echo "File '$c' already exists. Aborting."
        exit 1
    fi

    hook_src="$githooks_base/hooks/${hook_name}.hook"
    if ! [ -e "$hook_src" ]; then
        echo "Source hook '$hook_src' doesn't exists !"
        exit 1
    fi

    ln -sn "$githooks_base/hooks/${hook_name}.hook" "$l"
    cat - > "$c"

}

function git_hooks_follow() {
    local hook_name

    hook_name="sync-workdir"

    ## XXXvlab: remove reverse_host !
    usage="$exname follow BRANCH HOST:DIR REVERSE_HOST"

    if [ "$#" != 3  ]; then
        echo "Wrong number of arguments"
        echo "usage: $usage"
        exit 1
    fi

    branch=$1
    hostdir=$2
    revhost=$3

    host=$(echo $2 | cut -f 1 -d ":")
    dir=$(echo $2 | cut -f 2- -d ":")

    make_ssh_connection_work "$host" || exit 1

    md5=$(echo "$dir" | md5sum | cut -c 1-8 )
    name="${hook_name}_${host}_${md5}"

    make_git_hooks_inited || exit 1

    l="$gitdir/hooks/post-receive.d/$name.hook"
    c="$gitdir/hooks/post-receive.d/$name.conf"

    if [ -e "$l" ]; then
        echo "File '$l' already exists."
        exit 1
    fi

    ln -sn "$githooks_base/hooks/sync-workdir.hook" "$l"
    cat <<EOF > "$c"

HOST="$host"
DISTANT_REPO_DIR="$dir"
TARGET_BRANCH="$branch"

## XXXvlab: find another solution
SOURCE_REPO_FOR_TARGET_REPO="$revhost"

EOF

}
export -f git_hooks_follow



function git_hooks_release() {
    local hook_name

    hook_name="release-on-tag"
    ## XXXvlab: remove reverse_host !
    usage="$exname release TAG_REGEX HOST:DIR"

    if [ "$#" != 2  ]; then
        echo "Wrong number of arguments"
        echo "usage: $usage"
        exit 1
    fi

    tag_regex=$1
    hostdir=$2

    host=$(echo $hostdir | cut -f 1 -d ":")
    dir=$(echo $hostdir | cut -f 2- -d ":")

    make_ssh_connection_work "$host" || exit 1
    make_git_hooks_inited || exit 1

    init_action "$hook_name" "$dir" <<EOF

HOST="$host"
DISTANT_REPO_DIR="$dir"
TARGET_TAG_REGEX="$tag_regex"

EOF

}
export -f git_hooks_release


##
## Code
##

arg=$1
shift
if [ "$(type -t git_hooks_$arg)" == "function" ]; then
    git_hooks_$arg "$@"
else
    cmd_funcs=$(set | egrep "^git_hooks_[a-zA-Z0-9_]+ ()" | cut -f 1 -d " " | \
         cut -f 3- -d "_")

    echo "Unknown sub-command '$arg' for git-hooks"
    echo
    echo "This is the list of supported sub-commands:"
    for i in $cmd_funcs; do
       echo "   git-hooks $i"
    done
    echo
fi
